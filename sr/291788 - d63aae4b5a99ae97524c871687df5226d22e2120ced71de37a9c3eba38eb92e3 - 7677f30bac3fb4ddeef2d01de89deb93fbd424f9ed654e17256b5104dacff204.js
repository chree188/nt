"use strict";var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Player=function(){function Player(nickName,address,pubkey){_classCallCheck(this,Player);this.nickName=nickName;this.address=address;this.pubkey=pubkey;this.games=0;this.wins=0;this.draws=0;this.elo=1600}_createClass(Player,[{key:"toString",value:function toString(){return JSON.stringify({nickName:this.nickName,address:this.address,pubkey:this.pubkey,games:this.games,wins:this.wins,draws:this.draws,elo:this.elo})}},{key:"verify",value:function verify(msg,signature){return true}}],[{key:"fromString",value:function fromString(s){var o=JSON.parse(s);var p=new Player(o.nickName,o.address,o.pubkey);p.games=o.games;p.wins=o.wins;p.draws=o.draws;p.elo=o.elo;return p}}]);return Player}();var BOARD_ROWS=15;var BOARD_COLS=15;var Game=function(){function Game(id,players){_classCallCheck(this,Game);this.id=id;this.players=players;this.playerAccs=[];this.moves=[];this.currentMove=0;this.board=new Array(BOARD_ROWS*BOARD_COLS+1).join(" ");this.lastSig="";this.final=false;this.winner=null}_createClass(Game,[{key:"toString",value:function toString(){return JSON.stringify({id:this.id,players:this.players,moves:this.moves,final:this.final,winner:this.winner})}},{key:"isWin",value:function isWin(){var _this=this;var rDiagonal=function rDiagonal(r,c){var w=0;var sq=_this.board[r*BOARD_COLS+c];for(var x=c,y=r;x<BOARD_COLS&&y<BOARD_ROWS;x+=1,y+=1){if(sq===_this.board[y*BOARD_COLS+x]){w+=1}else{break}}return w>=5};var lDiagonal=function lDiagonal(r,c){var w=0;var sq=_this.board[r*BOARD_COLS+c];for(var x=c,y=r;x>=0&&y<BOARD_ROWS;x-=1,y+=1){if(sq===_this.board[y*BOARD_COLS+x]){w+=1}else{break}}return w>=5};var rightward=function rightward(r,c){var w=0;var sq=_this.board[r*BOARD_COLS+c];for(var x=c;x<BOARD_COLS;x+=1){if(sq===_this.board[r*BOARD_COLS+x]){w+=1}else{break}}return w>=5};var downward=function downward(r,c){var w=0;var sq=_this.board[r*BOARD_COLS+c];for(var y=r;y<BOARD_ROWS;y+=1){if(sq===_this.board[y*BOARD_COLS+c]){w+=1}else{break}}return w>=5};for(var i=0;i<BOARD_ROWS;i+=1){for(var j=0;j<BOARD_COLS;j+=1){if(this.board[i*BOARD_COLS+j]!==" "){if(downward(i,j)||rightward(i,j)||lDiagonal(i,j)||rDiagonal(i,j)){return this.board[i*BOARD_COLS+j]}}}}return false}},{key:"isDraw",value:function isDraw(){for(var i=0;i<BOARD_ROWS*BOARD_COLS;i+=1){if(this.board[i]===" "){return false}}return true}},{key:"isValidMove",value:function isValidMove(row,col){if(this.board[row*BOARD_COLS+col]!==" "){return false}return true}},{key:"applyMove",value:function applyMove(move){if(!this.verifyMove(move)){return false}var _move=_slicedToArray(move,7),address=_move[2],row=_move[4],col=_move[5],sig=_move[6];var mark=this.playerAccs[0].address===address?"X":"O";var index=row*BOARD_COLS+col;this.board=this.board.substr(0,index)+mark+this.board.substr(index+mark.length);this.currentMove+=1;this.lastSig=sig;this.moves.push(move);return true}},{key:"applyMoveNoVerify",value:function applyMoveNoVerify(move){var _move2=_slicedToArray(move,7),address=_move2[2],row=_move2[4],col=_move2[5],sig=_move2[6];var mark=this.playerAccs[0].address===address?"X":"O";var index=row*BOARD_COLS+col;this.board=this.board.substr(0,index)+mark+this.board.substr(index+mark.length);this.currentMove+=1;this.lastSig=sig;return true}},{key:"verifyMove",value:function verifyMove(move){var player=this.playerAccs[this.currentMove%2];var _move3=_slicedToArray(move,7),id=_move3[0],tag=_move3[1],address=_move3[2],moveN=_move3[3],row=_move3[4],col=_move3[5],sig=_move3[6];if(id!==this.id){return false}if(tag!=="move"){return false}if(address!==player.address){return false}if(moveN!==this.currentMove){return false}var moveString=JSON.stringify([id,"move",address,moveN,row,col,this.lastSig]);if(!player.verify(moveString,sig)){return false}return this.isValidMove(row,col)}}],[{key:"fromString",value:function fromString(s){var o=JSON.parse(s);var game=new Game(o.id,o.players);game.moves=o.moves;game.final=o.final;game.winner=o.winner;return game}}]);return Game}();var GomokuArbiter=function(){function GomokuArbiter(){_classCallCheck(this,GomokuArbiter);LocalContractStorage.defineMapProperties(this,{games:{parse:function parse(str){return str?Game.fromString(str):null},stringify:function stringify(game){return game?game.toString():"null"}},players:{parse:function parse(str){return str?Player.fromString(str):null},stringify:function stringify(player){return player?player.toString():null}}})}_createClass(GomokuArbiter,[{key:"init",value:function init(){this.players.set("abc",new Player("def","abc","zzz"))}},{key:"getPlayer",value:function getPlayer(address){return this.players.get(address)}},{key:"submitGame",value:function submitGame(id,players,moves){var _this2=this;var game=this.games.get(id);if(players.length!==2){throw new Error("Invalid number of players")}var playerAccs=players.map(function(p){var playerAcc=_this2.players.get(p.address);if(playerAcc){return playerAcc}var player=new Player(p.nickName,p.address,p.pubkey);_this2.players.set(player.address,player);return player});if(!game){game=new Game(id,players.map(function(player){return player.address}))}if(game.final){return}game.playerAccs=playerAccs;game.moves.forEach(function(move){game.applyMoveNoVerify(move)});moves.forEach(function(move){game.applyMove(move);var win=game.isWin();if(win){game.final=true;game.winner=win==="X"?game.players[0]:game.players[1]}else if(game.isDraw()){game.final=true;game.winner=null}});this.games.set(game.id,game);if(game.final){var Sa=.5;if(game.winner===game.players[0]){Sa=1;game.playerAccs[0].wins+=1}else if(game.winner){Sa=0}else{game.playerAccs[0].draws+=1}var Sb=.5;if(game.winner===game.players[1]){Sb=1;game.playerAccs[1].wins+=1}else if(game.winner){Sb=0}else{game.playerAccs[1].draws+=1}var Ra=game.playerAccs[0].elo;var Rb=game.playerAccs[1].elo;var Ea=1/(1+Math.pow(10,(Rb-Ra)/400));var Eb=1/(1+Math.pow(10,(Ra-Rb)/400));game.playerAccs[0].elo=Ra+16*(Sa-Ea);game.playerAccs[1].elo=Rb+16*(Sb-Eb);game.playerAccs[0].games+=1;game.playerAccs[1].games+=1}this.players.set(game.playerAccs[0].address,game.playerAccs[0]);this.players.set(game.playerAccs[1].address,game.playerAccs[1])}}]);return GomokuArbiter}();module.exports=GomokuArbiter;