"use strict";var ERR_MATCH_NOT_EXIST="当前比赛不存在";var ERR_MATCH_HAS_EXIST="当前比赛已存在";var ERR_MATCH_HAS_CLOSE="当前比赛已关闭";var ERR_MATCH_NOT_CLOSE="当前比赛未关闭";var ERR_MATCH_NOT_AUTH="你没用权限执行操作";var ERR_MATCH_NOT_VOTE="当前比赛暂无用户投票";var ERR_MATCH_DEAD_TIME="当前比赛投票已截止";var ERR_TRANS_FAILED="转账失败";var GAS_RATE=10000000000;var MatchInfo=function(obj){if(typeof obj==="string"){obj=JSON.parse(obj)}if(typeof obj==="object"){this.id=obj.id;this.redName=obj.redName;this.blueName=obj.blueName;this.title=obj.title;this.result=obj.result;this.deadTime=obj.deadTime;this.rate=obj.rate;this.redMoneys=obj.redMoneys instanceof BigNumber?obj.redMoneys:new BigNumber(obj.redMoneys);this.blueMoneys=obj.blueMoneys instanceof BigNumber?obj.blueMoneys:new BigNumber(obj.blueMoneys);this.redVotes=obj.redVotes;this.blueVotes=obj.blueVotes}};MatchInfo.prototype={toString:function(){return JSON.stringify(this)},addVote:function(voteInfo){if(voteInfo.choice===1){this.redMoneys=this.redMoneys.plus(voteInfo.money);this.redVotes.push(voteInfo)}else{if(voteInfo.choice===2){this.blueMoneys=this.blueMoneys.plus(voteInfo.money);this.blueVotes.push(voteInfo)}else{throw new Error("选择出错!")}}}};var VoteInfo=function(obj){if(typeof obj==="string"){obj=JSON.parse(obj)}if(typeof obj==="object"){this.owner=obj.owner;this.money=obj.money instanceof BigNumber?obj.money:new BigNumber(obj.money);this.choice=obj.choice;this.time=obj.time;this.state=obj.state}};VoteInfo.prototype={toString:function(){return JSON.stringify(this)}};var GuessContract=function(){LocalContractStorage.defineProperties(this,{_name:null,_creator:null});LocalContractStorage.defineProperty(this,"_money",{parse:function(str){return new BigNumber(str)},stringify:function(obj){return obj.toString()}});LocalContractStorage.defineMapProperties(this,{"matchInfos":{parse:function(value){return new MatchInfo(value)},stringify:function(o){return o.toString()}}})};GuessContract.prototype={init:function(){this._name="Match Guess";this._creator=Blockchain.transaction.from;this._money=new BigNumber(0)},addMatchInfo:function(matchId,redName,blueName,title,deadTime){var from=Blockchain.transaction.from;if(from!==this._creator){throw new Error(ERR_MATCH_NOT_AUTH)}var matchInfo=new MatchInfo({"id":matchId,"redName":redName,"blueName":blueName,"title":title,"result":0,"deadTime":deadTime,"rate":0,"redMoneys":new BigNumber(0),"blueMoneys":new BigNumber(0),"redVotes":[],"blueVotes":[]});var tempMatch=this.matchInfos.get(matchId);if(tempMatch){throw new Error(ERR_MATCH_HAS_EXIST)}this.matchInfos.set(matchId,matchInfo)},getMatchInfo:function(matchId){var matchInfo=this.matchInfos.get(matchId);if(!matchInfo){throw new Error(ERR_MATCH_NOT_EXIST)}return matchInfo},addVote:function(matchId,choice){var from=Blockchain.transaction.from;var value=Blockchain.transaction.value;var voteInfo=new VoteInfo({"owner":from,"money":value instanceof BigNumber?value:new BigNumber(value),"choice":choice,"time":Blockchain.transaction.timestamp.toString(10),"state":0});var matchInfo=this.matchInfos.get(matchId);if(!matchInfo){throw new Error(ERR_MATCH_NOT_EXIST)}if(matchInfo.result!==0){throw new Error(ERR_MATCH_HAS_CLOSE)}if(voteInfo.time>matchInfo.deadTime){throw new Error(ERR_MATCH_DEAD_TIME)}matchInfo.addVote(voteInfo);this.matchInfos.set(matchId,matchInfo)},updateMatchResult:function(matchId,result){var matchInfo=this.matchInfos.get(matchId);if(!matchInfo){throw new Error(ERR_MATCH_NOT_EXIST)}if(matchInfo.result!==0){throw new Error(ERR_MATCH_HAS_CLOSE)}matchInfo.result=result;if(matchInfo.result===1){var len=matchInfo.redVotes.length;if(len===0){throw new Error(ERR_MATCH_NOT_VOTE)}var gas=new BigNumber(len).times(GAS_RATE);this._money=this._money.plus(gas);var rate=matchInfo.redMoneys.plus(matchInfo.blueMoneys).minus(gas).div(matchInfo.redMoneys);var tempRate=rate.times(new BigNumber(100)).dividedToIntegerBy(new BigNumber(1)).dividedBy(new BigNumber(100));var balanceRate=rate.minus(tempRate);this._money=this._money.plus(matchInfo.redMoneys.times(balanceRate));matchInfo.rate=tempRate;for(var i=0;i<len;i++){var voteInfo=matchInfo.redVotes[i];var transferResult=Blockchain.transfer(voteInfo.owner,matchInfo.rate.times(voteInfo.money));if(!transferResult){voteInfo.state=2;matchInfo.redVotes[i]=voteInfo;this.matchInfos.set(matchId,matchInfo);throw new Error(ERR_TRANS_FAILED)}Event.Trigger("updateMatchResult",{Transfer:{from:Blockchain.transaction.to,to:voteInfo.owner,value:matchInfo.rate.times(voteInfo.money).toString()}});voteInfo.state=1;matchInfo.redVotes[i]=voteInfo;this.matchInfos.set(matchId,matchInfo)}}else{if(matchInfo.result===2){var len=matchInfo.blueVotes.length;if(len===0){throw new Error(ERR_MATCH_NOT_VOTE)}var gas=new BigNumber(len).times(GAS_RATE);this._money=this._money.plus(gas);var rate=matchInfo.blueMoneys.plus(matchInfo.redMoneys).minus(gas).div(matchInfo.blueMoneys);var tempRate=rate.times(new BigNumber(100)).dividedToIntegerBy(new BigNumber(1)).dividedBy(new BigNumber(100));var balanceRate=rate.minus(tempRate);this._money=this._money.plus(matchInfo.blueMoneys.times(balanceRate));
matchInfo.rate=tempRate;for(var i=0;i<len;i++){var voteInfo=matchInfo.blueVotes[i];var transferResult=Blockchain.transfer(voteInfo.owner,matchInfo.rate.times(voteInfo.money));if(!transferResult){voteInfo.state=2;matchInfo.blueVotes[i]=voteInfo;this.matchInfos.set(matchId,matchInfo);throw new Error(ERR_TRANS_FAILED)}Event.Trigger("updateMatchResult",{Transfer:{from:Blockchain.transaction.to,to:voteInfo.owner,value:matchInfo.rate.times(voteInfo.money).toString()}});voteInfo.state=1;matchInfo.blueVotes[i]=voteInfo;this.matchInfos.set(matchId,matchInfo)}}}},updateVoteByMatchId:function(matchId,choice){var matchInfo=this.matchInfos.get(matchId);if(!matchInfo){throw new Error(ERR_MATCH_NOT_EXIST)}var from=Blockchain.transaction.from;if(matchInfo.result===1&&choice===1){var len=matchInfo.redVotes.length;if(len===0){throw new Error(ERR_MATCH_NOT_VOTE)}for(var i=0;i<len;i++){var voteInfo=matchInfo.redVotes[i];if(voteInfo.owner===from&&voteInfo.state===2){matchInfo.rate=matchInfo.rate instanceof BigNumber?matchInfo.rate:new BigNumber(matchInfo.rate);var transferResult=Blockchain.transfer(voteInfo.owner,matchInfo.rate.times(voteInfo.money));if(!transferResult){throw new Error(ERR_TRANS_FAILED)}Event.Trigger("updateVoteByMatchId",{Transfer:{from:Blockchain.transaction.to,to:voteInfo.owner,value:voteInfo.money.times(matchInfo.rate).toString()}});voteInfo.state=1;matchInfo.redVotes[i]=voteInfo;this.matchInfos.set(matchId,matchInfo)}}}else{if(matchInfo.result===2&&choice===2){var len=matchInfo.blueVotes.length;if(len===0){throw new Error(ERR_MATCH_NOT_VOTE)}for(var i=0;i<len;i++){var voteInfo=matchInfo.blueVotes[i];if(voteInfo.owner===from&&voteInfo.state===2){matchInfo.rate=matchInfo.rate instanceof BigNumber?matchInfo.rate:new BigNumber(matchInfo.rate);var transferResult=Blockchain.transfer(voteInfo.owner,matchInfo.rate.times(voteInfo.money));if(!transferResult){throw new Error(ERR_TRANS_FAILED)}Event.Trigger("updateVoteByMatchId",{Transfer:{from:Blockchain.transaction.to,to:voteInfo.owner,value:voteInfo.money.times(matchInfo.rate).toString()}});voteInfo.state=1;matchInfo.blueVotes[i]=voteInfo;this.matchInfos.set(matchId,matchInfo)}}}else{throw new Error(ERR_MATCH_NOT_CLOSE)}}},getBalance:function(value){var from=Blockchain.transaction.from;var amount=new BigNumber(value);if(from!==this._creator){throw new Error(ERR_MATCH_NOT_AUTH)}if(this._money.lt(amount)){throw new Error("余额不足")}if(value===0){return this._money}var transferResult=Blockchain.transfer(this._creator,amount);if(!transferResult){throw new Error(ERR_TRANS_FAILED)}Event.Trigger("getBalance",{Transfer:{from:Blockchain.transaction.to,to:from,value:amount.toString()}});this._money=this._money.minus(amount)}};module.exports=GuessContract;