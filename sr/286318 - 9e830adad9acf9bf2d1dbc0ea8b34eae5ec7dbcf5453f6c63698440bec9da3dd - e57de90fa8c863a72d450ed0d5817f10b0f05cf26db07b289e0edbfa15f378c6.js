"use strict";var QTag=function(t){if(t){var e=JSON.parse(t);this.author=e.author;this.key=e.key;this.name=e.name;this.time=e.time}else{this.author="";this.key="";this.name="";this.time=(new Date).getTime()}};QTag.prototype={toString:function(){return JSON.stringify(this)}};var QNote=function(t){if(t){var e=JSON.parse(t);this.author=e.author;this.key=e.key;this.text=e.text;this.color=e.color;this.qtag=e.qtag;this.time=e.time}else{this.author="";this.key="";this.text="";this.color=0;this.qtag="";this.time=(new Date).getTime()}};QNote.prototype={toString:function(){return JSON.stringify(this)}};var QuicknoteContract=function(){LocalContractStorage.defineProperty(this,"userSize",{stringify:function(t){return t.toString()},parse:function(t){return new BigNumber(t)}});LocalContractStorage.defineMapProperty(this,"users");LocalContractStorage.defineMapProperty(this,"userSeqs",{stringify:function(t){return t.toString()},parse:function(t){return new BigNumber(t)}});LocalContractStorage.defineMapProperty(this,"qtagKeys");LocalContractStorage.defineMapProperty(this,"qtags",{parse:function(t){return new QTag(t)},stringify:function(t){return t.toString()}});LocalContractStorage.defineMapProperty(this,"qnoteKeys");LocalContractStorage.defineMapProperty(this,"qnoteKeysInQTag");LocalContractStorage.defineMapProperty(this,"qnotes",{parse:function(t){return new QNote(t)},stringify:function(t){return t.toString()}})};QuicknoteContract.prototype={init:function(){this.userSize=new BigNumber(0)},register:function(){var t=Blockchain.transaction.from,e=this.userSeqs.get(t);console.log("author",t,this.userSize);if(!e){this.userSize=this.userSize.plus(1);e=this.userSize;this.userSeqs.put(t,e);this.users.put(e,t)}},saveQTag:function(t,e){this.register();t=t.trim();e=e.trim();if(""===t||""===e)throw new Error("empty key / name");var r,i=Blockchain.transaction.from,n=this.qtagKeys.get(i),s=i+"_"+t;if(!n||n.indexOf(t)<0){n||(n=new Array);n.unshift(t);this.qtagKeys.put(i,n);r=new QTag;r.key=t;r.author=i}else{r=this.qtags.get(s);if(!r){r=new QTag;r.key=t;r.author=i}}r.name=e;this.qtags.put(s,r)},queryQTag:function(t,e){var r=new Array;t=parseInt(t);e=parseInt(e);var i=Blockchain.transaction.from,n=this.qtagKeys.get(i);if(!n||n.length<1)return r;var s=e+t;s>n.length&&(s=n.length);for(var o=e;o<s;o++){var a=i+"_"+n[o],h=this.qtags.get(a);r.push(h)}return r},saveQNote:function(t,e,r,i){this.register();t=t.trim();e=e.trim();i=i.trim();if(""===t||""===e)throw new Error("empty key / text");var n,s=Blockchain.transaction.from,o=this.qnoteKeys.get(s),a=s+"_"+t;if(!o||o.indexOf(t)<0){o||(o=new Array);o.unshift(t);this.qnoteKeys.put(s,o);if(""!==i){var h=s+"_"+i,u=this.qnoteKeysInQTag.get(h);u||(u=new Array);if(u.indexOf(t)<0){u.unshift(t);this.qnoteKeysInQTag.put(h,u)}}n=new QNote;n.key=t;n.qtag=i;n.author=s}else{n=this.qnotes.get(a);if(!n){n=new QNote;n.key=t;n.qtag=i;n.author=s}}n.text=e;n.color=parseInt(r);this.qnotes.put(a,n)},queryQNote:function(t,e,r){var i=new Array;t=parseInt(t);e=parseInt(e);var n,s=Blockchain.transaction.from;if(r){r=s+"_"+r;n=this.qnoteKeysInQTag.get(r)}else n=this.qnoteKeys.get(s);if(!n||n.length<1)return i;var o=e+t;o>n.length&&(o=n.length);for(var a=e;a<o;a++){var h=s+"_"+n[a],u=this.qnotes.get(h);i.push(u)}return i},stats:function(){for(var t=new BigNumber(0),e=new BigNumber(0),r=new BigNumber(1);r.lte(this.userSize);r=r.plus(1)){var i=this.users.get(r);if(i){var n=this.qtagKeys.get(i);n&&(t=t.plus(n.length));var s=this.qnoteKeys.get(i);s&&(e=e.plus(s.length))}}return{user:this.userSize,qtag:t,qnote:e}}};module.exports=QuicknoteContract;