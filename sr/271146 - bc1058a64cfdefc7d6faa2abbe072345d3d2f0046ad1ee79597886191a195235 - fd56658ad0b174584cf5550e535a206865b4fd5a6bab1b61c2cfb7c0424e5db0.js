"use strict";var Diary=function(text){if(text){var o=JSON.parse(text);this.title=o.title;this.content=o.content;this.author=o.author;this.date=o.date}else{this.title="";this.content="";this.author="";this.date=""}};Diary.prototype={toString:function(){return JSON.stringify(this)}};var LoveDay=function(text){if(text){var o=JSON.parse(text);this.name=o.name;this.date=o.date;this.flag=o.flag}else{this.name="";this.date="";this.flag=""}};LoveDay.prototype={toString:function(){return JSON.stringify(this)}};var LoveMark=function(text){if(text){var o=JSON.parse(text);this.mFrom=o.mFrom;this.tFrom=o.tFrom;this.mName=o.mName;this.tName=o.tName;this.sex=o.sex;this.birthDay=o.birthDay;this.lToken=o.lToken;this.dec=o.dec;this.loveDays=o.loveDays;this.diarys=o.diarys;this.number=o.number;this.createTime=o.createTime}else{this.mFrom="";this.tFrom="";this.mName="";this.tName="";this.sex="";this.lToken="";this.dec="";this.loveDays=[];this.diarys=[];this.number="";this.createTime=new Date().getTime()}};LoveMark.prototype={toString:function(){return JSON.stringify(this)}};var LoveMarkContract=function(){LocalContractStorage.defineMapProperty(this,"LoveMarkMap",{parse:function(text){return new LoveMark(text)},stringify:function(o){return o.toString()}});LocalContractStorage.defineMapProperty(this,"LoveDayMap",{parse:function(text){return new LoveDay(text)},stringify:function(o){return o.toString()}});LocalContractStorage.defineMapProperty(this,"DiaryMap",{parse:function(text){return new Diary(text)},stringify:function(o){return o.toString()}});LocalContractStorage.defineProperty(this,"number");LocalContractStorage.defineProperty(this,"loveDayKey");LocalContractStorage.defineProperty(this,"diaryKey")};LoveMarkContract.prototype={init:function(){this.number=1;this.loveDayKey=0;this.diaryKey=0},saveLoveMark:function(mName,tName,sex,birthDay,lToken,dec){if(!mName||!tName||!sex||!lToken||!dec){throw new Error("[mName or tName or sex or lToken or dec] Can not be empty")}var loveDayKey=this._saveLoveDay(mName+"生日",birthDay,"2");var mFrom=Blockchain.transaction.from;var loveMark=new LoveMark();loveMark.mFrom=mFrom;loveMark.mName=mName;loveMark.tName=tName;loveMark.sex=sex;loveMark.birthDay=birthDay;loveMark.lToken=lToken;loveMark.dec=dec;loveMark.number=this.number;loveMark.loveDays=[loveDayKey];loveMark.diarys=[];loveMark.createTime=new Date().getTime();this.LoveMarkMap.put(mFrom,loveMark);this.number+=1},setTFrom:function(tFrom,birthDay,isRegister){if(!tFrom||!isRegister){throw new Error("[tFrom or birthDay or isRegister] Can not be empty")}if(!Blockchain.verifyAddress(tFrom)){throw new Error("["+tFrom+"]不是钱包地址啦，直接复制吧，千万不要手敲哦^_^")}var mFrom=Blockchain.transaction.from;var mLoveMark=this.LoveMarkMap.get(mFrom);if(!mLoveMark){throw new Error("宝贝儿，你还未注册哦，先去注册在设置另一半的恋爱地址吧")}if(mLoveMark.tFrom){throw new Error("宝贝儿，你已绑定了TA，千万不要脚踏两只船哦")}var tLoveMark=this.LoveMarkMap.get(tFrom);if("1"===isRegister){if(!tLoveMark){throw new Error("["+tFrom+"]还未注册哦，快快邀请TA注册吧")}if(tLoveMark.tFrom){throw new Error("["+tFrom+"]已被其他人绑定过啦")}tLoveMark.tFrom=mFrom}else{if("2"===isRegister){if(!birthDay){throw new Error("birthDay] Can not be empty")}if(tLoveMark){throw new Error("["+tFrom+"]已经注册过啦，请选择已注册恋爱印记哦~")}var loveDayKey=this._saveLoveDay(mLoveMark.tName+"生日",birthDay,"2");mLoveMark.loveDays.push(loveDayKey);tLoveMark=new LoveMark();tLoveMark.mFrom=tFrom;tLoveMark.tFrom=mFrom;tLoveMark.mName=mLoveMark.tName;tLoveMark.tName=mLoveMark.mName;if(mLoveMark.sex==="男"){tLoveMark.sex="女"}else{tLoveMark.sex="男"}tLoveMark.birthDay=birthDay;tLoveMark.lToken=mLoveMark.lToken;tLoveMark.dec=mLoveMark.dec;tLoveMark.number=this.number;tLoveMark.loveDays=mLoveMark.loveDays;tLoveMark.diarys=[];tLoveMark.createTime=new Date().getTime();this.LoveMarkMap.put(tFrom,tLoveMark);this.number+=1}else{throw new Error("参数错误")}}mLoveMark.tFrom=tFrom;this.LoveMarkMap.set(mFrom,mLoveMark);this.LoveMarkMap.set(tFrom,tLoveMark)},saveLoveDay:function(name,date,isSync){if(!name||!date||!isSync){throw new Error("[name or date or isSync] Can not be empty")}var mFrom=Blockchain.transaction.from;var mLoveMark=this.LoveMarkMap.get(mFrom);if(!mLoveMark){throw new Error("["+mFrom+"]还未注册哦，先注册再使用吧^_^")}var loveDayKey=this._saveLoveDay(name,date,"1");mLoveMark.loveDays.push(loveDayKey);if("1"===isSync){var tFrom=mLoveMark.tFrom;if(tFrom){var tLoveMark=this.LoveMarkMap.get(tFrom);tLoveMark.loveDays.push(loveDayKey);this.LoveMarkMap.set(tFrom,tLoveMark)}}this.LoveMarkMap.set(mFrom,mLoveMark)},_saveLoveDay:function(name,date,flag){var key=this.loveDayKey;var loveDay=new LoveDay();loveDay.name=name;loveDay.date=date;loveDay.flag=flag;this.LoveDayMap.set(key,loveDay);this.loveDayKey+=1;return key},saveDiary:function(title,content,isSync){if(!title||!content||!isSync){throw new Error("[title or content or isSync] Can not be empty")}var mFrom=Blockchain.transaction.from;var mLoveMark=this.LoveMarkMap.get(mFrom);if(!mLoveMark){throw new Error("["+mFrom+"]还未注册哦，先注册再使用吧^_^")}var diaryKey=this.diaryKey;var diary=new Diary();
diary.title=title;diary.content=content;diary.author=mLoveMark.mName;diary.date=new Date().Format("yyyy-MM-dd hh:mm:ss");this.DiaryMap.put(diaryKey,diary);this.diaryKey+=1;mLoveMark.diarys.push(diaryKey);if("1"===isSync){var tFrom=mLoveMark.tFrom;if(tFrom){var tLoveMark=this.LoveMarkMap.get(tFrom);tLoveMark.diarys.push(diaryKey);this.LoveMarkMap.set(tFrom,tLoveMark)}}this.LoveMarkMap.set(mFrom,mLoveMark)},_getLoveMark:function(from){if(!from){throw new Error("[from] Can not be empty")}if(!Blockchain.verifyAddress(from)){throw new Error("["+from+"]不是钱包地址啦，直接复制吧，千万不要手敲哦^_^")}return this.LoveMarkMap.get(from)},getLoveMark:function(from){return this._getLoveMark(from)},getLoveDay:function(from){var loveMark=this._getLoveMark(from);var loveDays=loveMark.loveDays;var loveDayArray=[];for(var i=0;i<loveDays.length;i++){loveDayArray.push(this.LoveDayMap.get(loveDays[i]))}return loveDayArray},getDiary:function(from){var loveMark=this._getLoveMark(from);var diarys=loveMark.diarys;var diaryArray=[];for(var i=0;i<diarys.length;i++){diaryArray.push(this.DiaryMap.get(diarys[i]))}return diaryArray},checkFrom:function(from){if(!from){throw new Error("[from] Can not be empty")}if(!Blockchain.verifyAddress(from)){throw new Error("["+from+"]不是钱包地址啦，直接复制吧，千万不要手敲哦^_^")}var loveMarkMap=this.LoveMarkMap.get(from);return !!loveMarkMap}};Date.prototype.Format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)))}}return fmt};module.exports=LoveMarkContract;