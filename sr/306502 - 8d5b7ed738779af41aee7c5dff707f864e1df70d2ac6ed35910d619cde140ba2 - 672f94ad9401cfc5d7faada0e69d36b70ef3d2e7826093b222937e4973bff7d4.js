"use strict";var RaiseContract=function(){LocalContractStorage.defineMapProperty(this,"joins");LocalContractStorage.defineProperty(this,"joinArray");LocalContractStorage.defineProperty(this,"create");LocalContractStorage.defineProperty(this,"jointCount");LocalContractStorage.defineProperty(this,"amount",{parse:function(text){return new BigNumber(text)},stringify:function(o){return o.toString()}});LocalContractStorage.defineProperty(this,"cost");LocalContractStorage.defineProperty(this,"status")};RaiseContract.prototype={init:function(){this.create=Blockchain.transaction.from;this.amount=new BigNumber(0);this.jointCount=0;this.status=1;this.joinArray=[]},join:function(){if(this.status==2){throw new Error("此聚会已结束!")}if(this.status==3){throw new Error("此聚会已取消!")}if(this.status!=1){throw new Error("此聚会状态异常!")}var from=Blockchain.transaction.from;var value=Blockchain.transaction.value;var users=this.joinArray;if(users.indexOf(from)==-1){this.amount=this.amount.plus(value);this.jointCount=this.jointCount+1;this.joins.set(from,value);users.push(from);this.joinArray=users}},cancelJoin:function(){if(this.status==2){throw new Error("此聚会已结束!")}if(this.status==3){throw new Error("此聚会已取消!")}if(this.status!=1){throw new Error("此聚会状态异常!")}var from=Blockchain.transaction.from;var value=Blockchain.transaction.value;var users=this.joinArray;var idx=users.indexOf(from);if(idx>=0){users.splice(idx,1);this.joinArray=users}var thisJoinValue=this.joins.get(from);if(!thisJoinValue||thisJoinValue<=0){return}var result=Blockchain.transfer(from,thisJoinValue);if(!result){throw new Error("退款失败，请稍后再试！")}this.amount=this.amount.minus(thisJoinValue);this.jointCount=this.jointCount-1;this.joins.del(from)},cancel:function(){if(this.status==2){throw new Error("此聚会已结束!")}if(this.status==3){throw new Error("此聚会已取消!")}if(this.status!=1){throw new Error("此聚会状态异常!")}var from=Blockchain.transaction.from;var value=Blockchain.transaction.value;if(from!=this.create){throw new Error("您不是此聚会的发起人，无法取消!选择的钱包要与发起时的钱包一致!")}var users=this.joinArray;var len=users.length;if(users&&len>0){for(var i=0;i<len;i++){var currentFrom=users[i];var thisJoinValue=this.joins.get(currentFrom);this.jointCount=this.jointCount-1;if(thisJoinValue&&thisJoinValue>=0&&this.amount>=thisJoinValue){Blockchain.transfer(currentFrom,thisJoinValue);this.amount=this.amount.minus(thisJoinValue)}}}this.status=3},end:function(){if(this.status==2){throw new Error("此聚会已结束!")}if(this.status==3){throw new Error("此聚会已取消!")}if(this.status!=1){throw new Error("此聚会状态异常!")}var from=Blockchain.transaction.from;var value=Blockchain.transaction.value;if(from!=this.create){throw new Error("您不是此聚会的发起人，无法结束!选择的钱包要与发起时的钱包一致!")}Blockchain.transfer(from,this.amount);this.status=2},_checkStatus:function(){if(this.status==2){throw new Error("此聚会已结束!")}if(this.status==3){throw new Error("此聚会已取消!")}if(this.status!=1){throw new Error("此聚会状态异常!")}return true}};module.exports=RaiseContract;